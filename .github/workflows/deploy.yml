name: Deploy to EC2 (PROD)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            tony0103/careplan-backend:latest
            tony0103/careplan-backend:${{ github.sha }}

      - name: Deploy to EC2 (PROD)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script_stop: true
          script: |
            set -e
            mkdir -p ~/app
            cd ~/app

            # (1) docker-compose.yml 생성/갱신
            printf "%s\n" \
              "services:" \
              "  backend-prod:" \
              "    image: tony0103/careplan-backend:latest" \
              "    container_name: careplan-backend" \
              "    env_file:" \
              "      - .env" \
              "    ports:" \
              "      - \"8080:8080\"" \
              "    restart: always" \
              > docker-compose.yml

            # (2) 배포 때마다 .env 갱신
            printf "%s\n" \
              "SPRING_PROFILES_ACTIVE=prod" \
              "DB_URL=${{ secrets.DB_URL }}" \
              "DB_USERNAME=${{ secrets.DB_USERNAME }}" \
              "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
              "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
              > .env

            # (3) 최신 이미지 pull + 재기동
            docker compose pull backend-prod
            docker compose up -d backend-prod

            # (4) 찌꺼기 정리
            docker image prune -f

            # (5) 확인
            docker ps
